# 抽奖功能 (Lottery Feature)

## 功能介绍

这是为 bavabot 添加的抽奖功能，允许管理员创建抽奖活动，用户可以使用樱花币参与抽奖。

## 功能特点

- 🎲 **多级奖品系统**: 支持一等奖、二等奖、三等奖、参与奖等多个奖项
- 💰 **樱花币支付**: 使用现有的樱花币系统作为参与费用
- 🏆 **公平抽奖**: 采用加权随机算法，确保抽奖公平性
- 👥 **人数限制**: 可设置最大参与人数
- ⏰ **时间限制**: 可设置抽奖持续时间
- 🎨 **可视化界面**: 自动生成抽奖图片
- 📊 **管理功能**: 管理员可以查看、关闭抽奖

## 命令说明

### 用户命令

- `/lotteries` - 查看当前活跃的抽奖

### 管理员命令

- `/lottery [标题] [参与费用] [最大人数] [持续时间分钟]` - 创建抽奖
  - 例如：`/lottery 新年抽奖 10 50 60`
- `/lottery_close [抽奖ID]` - 关闭指定抽奖并退还费用

### 按钮操作

- 🎲 **参与抽奖** - 点击参与抽奖（消耗樱花币）
- 📊 **查看详情** - 查看抽奖详细信息
- 🏆 **开始抽奖** - 管理员可以手动开奖

## 配置选项

管理员可以通过 `/config` 命令调整以下设置：

- **抽奖功能开关**: 启用/禁用整个抽奖系统
- **管理员创建抽奖**: 是否只允许管理员创建抽奖
- **最大参与费用**: 限制单次抽奖的参与费用上限
- **最大参与人数**: 限制单次抽奖的参与人数上限
- **最大持续时间**: 限制单次抽奖的最长持续时间

## 奖品设置

默认奖品配置（可在代码中调整）：

- **一等奖**: 参与费用 × 50，概率 1%，数量 1
- **二等奖**: 参与费用 × 20，概率 5%，数量 2
- **三等奖**: 参与费用 × 10，概率 10%，数量 5
- **参与奖**: 参与费用 × 2，概率 30%，数量 20

## 使用示例

1. 管理员创建抽奖：
   ```
   /lottery 周末抽奖 20 100 120
   ```

2. 用户查看抽奖：
   ```
   /lotteries
   ```

3. 用户参与抽奖：点击抽奖消息下的"🎲 参与抽奖"按钮

4. 管理员开奖：点击"🏆 开始抽奖"按钮

5. 如需关闭抽奖：
   ```
   /lottery_close ABC123
   ```

## 技术实现

- **存储**: 使用内存存储（类似红包功能），重启后数据清空
- **随机算法**: 使用加权随机算法确保按概率分配奖品
- **并发安全**: 基于异步处理，避免并发问题
- **图片生成**: 使用 PIL 库生成抽奖宣传图片
- **日志记录**: 记录创建、参与、开奖等关键操作

## 注意事项

1. 抽奖数据存储在内存中，机器人重启后会丢失
2. 参与抽奖需要先注册账户并有足够的樱花币
3. 一旦参与抽奖，樱花币会立即扣除
4. 只有创建者和管理员可以开奖
5. 过期的抽奖会自动标记为已结束

## 扩展计划

- [ ] 数据库持久化存储
- [ ] 自定义奖品配置界面
- [ ] 定时自动开奖
- [ ] 抽奖历史记录
- [ ] 更丰富的图片模板